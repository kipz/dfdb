
Running tests in #{"perf"}

Testing dfdb.joins-aggregates-performance-test

 ======================================================================
Self-Join: Mutual friendship detection
======================================================================
Loading initial data...
Creating subscription...
Compilation time: 28.93ms

Running subscription updates...
Running naive query re-executions...

--- Results ---
Subscription avg: 2.70ms
Naive avg: 3.96ms
Speedup: 1.5x
Results match: true

 ======================================================================
3-Way Join: Friend³
======================================================================
Loading initial data...
Creating subscription...
Compilation time: 17.29ms

Running subscription updates...
Running naive query re-executions...

--- Results ---
Subscription avg: 2.08ms
Naive avg: 4.51ms
Speedup: 2.2x
Results match: true

 ======================================================================
Complex Aggregate: Count, Sum, Avg by type
======================================================================
Loading initial data...
Creating subscription...
Compilation time: 64.25ms

Running subscription updates...
Running naive query re-executions...

--- Results ---
Subscription avg: 24.02ms
Naive avg: 15.13ms
Speedup: 0.6x
Results match: true

FAIL in (test-complex-aggregation) (joins_aggregates_performance_test.clj:354)
Complex Aggregation: Multiple aggregates with grouping
expected: (> (:speedup result) 1.0)
  actual: (not (> 1513093587/2401517749 1.0))

 ======================================================================
Hierarchical: 3-level management chain
======================================================================
Loading initial data...
Creating subscription...
Compilation time: 4.60ms

Running subscription updates...
Running naive query re-executions...

--- Results ---
Subscription avg: 1.37ms
Naive avg: 1.38ms
Speedup: 1.0x
Results match: true

FAIL in (test-manager-chain) (joins_aggregates_performance_test.clj:339)
Hierarchical Join: Employee → Manager → Skip-Level
expected: (> (:speedup result) 1.5)
  actual: (not (> 68969833/68390336 1.5))

 ======================================================================
Join + Aggregate: Sum by account type
======================================================================
Loading initial data...
Creating subscription...
Compilation time: 39.13ms

Running subscription updates...
Running naive query re-executions...

--- Results ---
Subscription avg: 13.69ms
Naive avg: 10.47ms
Speedup: 0.8x
Results match: true

FAIL in (test-join-plus-aggregate) (joins_aggregates_performance_test.clj:306)
Join + Aggregate: Total amount by account type
expected: (> (:speedup result) 1.5)
  actual: (not (> 523342977/684735746 1.5))

 ======================================================================
Triangle Join: A→B, B→C, A→C
======================================================================
Loading initial data...
Creating subscription...
Compilation time: 9.26ms

Running subscription updates...
Running naive query re-executions...

--- Results ---
Subscription avg: 1.45ms
Naive avg: 2.65ms
Speedup: 1.8x
Results match: true

FAIL in (test-triangle-join) (joins_aggregates_performance_test.clj:368)
Triangle Join: Transitive closure pattern
expected: (> (:speedup result) 2.0)
  actual: (not (> 79466333/43554829 2.0))

 ======================================================================
Aggregation: Count transactions by type
======================================================================
Loading initial data...
Creating subscription...
Compilation time: 5.72ms

Running subscription updates...
Running naive query re-executions...

--- Results ---
Subscription avg: 6.13ms
Naive avg: 1.77ms
Speedup: 0.3x
Results match: true

 ======================================================================
Star Schema: 4-way join on users
======================================================================
Loading initial data...
Creating subscription...
Compilation time: 23.87ms

Running subscription updates...
Running naive query re-executions...

--- Results ---
Subscription avg: 4.62ms
Naive avg: 6.99ms
Speedup: 1.5x
Results match: true

 ======================================================================
Filtered Aggregate: Sum of high-value by type
======================================================================
Loading initial data...
Creating subscription...
Compilation time: 19.77ms

Running subscription updates...
Running naive query re-executions...

--- Results ---
Subscription avg: 11.46ms
Naive avg: 7.70ms
Speedup: 0.7x
Results match: true

 ======================================================================
4-Way Join: Friend⁴
======================================================================
Loading initial data...
Creating subscription...
Compilation time: 14.52ms

Running subscription updates...
Running naive query re-executions...

--- Results ---
Subscription avg: 2.20ms
Naive avg: 4.97ms
Speedup: 2.3x
Results match: true

 ======================================================================
Multi-Join Aggregate: Orders by city + status
======================================================================
Loading initial data...
Creating subscription...
Compilation time: 113.71ms

Running subscription updates...
Running naive query re-executions...

--- Results ---
Subscription avg: 17.11ms
Naive avg: 29.95ms
Speedup: 1.8x
Results match: true

FAIL in (test-multi-join-aggregate) (joins_aggregates_performance_test.clj:324)
Multi-Join + Aggregate: Orders by city and status
expected: (> (:speedup result) 2.0)
  actual: (not (> 1497270979/855362376 2.0))

Testing dfdb.performance-smoke-test

Testing dfdb.performance-test

 ================================================================================
Scenario: High-Churn - Active Sessions
Scale: 500 users, 2000 sessions
Updates: 200
================================================================================

Setting up initial data...
Initial data loaded
Initial memory usage: 73.50 MB

Warming up JVM...

--- Subscription Setup ---
Compilation time: 24.55 ms
Subscription active. Initial results delivered.
Initial result count: 0

--- Generating Updates ---
Generated 200 update batches

--- Subscription Benchmark ---
Completed 200 updates via subscription
Stats: mean: 10.99ms, p50: 10.72ms, p95: 13.51ms, p99: 14.66ms, min: 9.80ms, max: 17.74ms
Total time: 2198.70 ms
Throughput: 90.96 updates/sec
Memory delta: 619.09 MB

--- Naive Query Benchmark ---
Completed 200 updates with naive queries
Stats: mean: 7.90ms, p50: 7.80ms, p95: 8.83ms, p99: 10.50ms, min: 7.38ms, max: 10.59ms
Total time: 1580.30 ms
Throughput: 126.56 updates/sec
Memory delta: -1366.05 MB

--- Results Validation ---
Subscription final result count: 0
Naive query final result count: 0
Results match: true

--- Summary ---
Speedup: 0.7x
Subscription avg latency: 10.99 ms
Naive query avg latency: 7.90 ms

FAIL in (scenario-4-high-churn-sessions) (performance_test.clj:441)
High-Churn: Active User Sessions
Subscriptions should be faster for high-churn workloads
expected: (> (:speedup results) 1.0)
  actual: (not (> 0.7187409133487284 1.0))

 ================================================================================
Scenario: Micro Updates (1-5 datoms)
Scale: 1000 products, micro updates
Updates: 50
================================================================================

Setting up initial data...
Initial data loaded
Initial memory usage: 460.53 MB

Warming up JVM...

--- Subscription Setup ---
Compilation time: 5.84 ms
Subscription active. Initial results delivered.
Initial result count: 172

--- Generating Updates ---
Generated 50 update batches

--- Subscription Benchmark ---
Completed 50 updates via subscription
Stats: mean: 4.03ms, p50: 3.99ms, p95: 4.36ms, p99: 4.51ms, min: 3.75ms, max: 4.51ms
Total time: 201.54 ms
Throughput: 248.09 updates/sec
Memory delta: 297.00 MB

--- Naive Query Benchmark ---
Completed 50 updates with naive queries
Stats: mean: 2.74ms, p50: 2.74ms, p95: 2.90ms, p99: 3.16ms, min: 2.60ms, max: 3.16ms
Total time: 137.16 ms
Throughput: 364.53 updates/sec
Memory delta: 604.00 MB

--- Results Validation ---
Subscription final result count: 164
Naive query final result count: 164
Results match: true

--- Summary ---
Speedup: 0.7x
Subscription avg latency: 4.03 ms
Naive query avg latency: 2.74 ms

 ================================================================================
Scenario: Social Network - Large Scale
Scale: 5000 users, avg 20 friends
Updates: 100
================================================================================

Setting up initial data...
Initial data loaded
Initial memory usage: 2116.96 MB

Warming up JVM...

--- Subscription Setup ---
Compilation time: 6572.31 ms
Subscription active. Initial results delivered.
Initial result count: 5000

--- Generating Updates ---
Generated 100 update batches

--- Subscription Benchmark ---
Completed 100 updates via subscription
Stats: mean: 264.86ms, p50: 265.11ms, p95: 272.94ms, p99: 290.15ms, min: 204.52ms, max: 290.15ms
Total time: 26486.26 ms
Throughput: 3.78 updates/sec
Memory delta: -355.91 MB

--- Naive Query Benchmark ---
